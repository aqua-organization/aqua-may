name: Deploy to Staging

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - develop

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    # Only deploy when CI workflow succeeds and it's a push event (not PR)
    if: |
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'develop'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.DEPLOY_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge develop into staging
        run: |
          git fetch origin develop staging || true
          if git rev-parse --verify origin/staging >/dev/null 2>&1; then
            # Use -B to force create/reset the branch
            git checkout -B staging origin/staging
          else
            echo "Staging branch does not exist, creating it from develop"
            git checkout -B staging origin/develop
          fi
          git merge origin/develop --no-edit -m "chore: auto-merge develop into staging [skip ci]"
          git push https://${{ secrets.DEPLOY_TOKEN }}@github.com/${{ github.repository }}.git staging

      - name: Trigger Frontend Deployment
        run: |
          echo "Triggering frontend deployment on Render..."
          response=$(curl -X POST -s -w "\n%{http_code}" "https://api.render.com/deploy/srv-d49gsg8gjchc73fcrua0?key=iWYsGX728j0")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ] || [ "$http_code" -eq 202 ]; then
            echo "Frontend deployment triggered successfully"
            echo "Response: $body"
          else
            echo "Failed to trigger frontend deployment. HTTP Status: $http_code"
            echo "Response: $body"
            exit 1
          fi

      - name: Trigger Backend Deployment
        run: |
          echo "Triggering backend deployment on Render..."
          response=$(curl -X POST -s -w "\n%{http_code}" "https://api.render.com/deploy/srv-d49fpsc9c44c73bl7ivg?key=TGCN5D8JYHc")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ] || [ "$http_code" -eq 202 ]; then
            echo "Backend deployment triggered successfully"
            echo "Response: $body"
          else
            echo "Failed to trigger backend deployment. HTTP Status: $http_code"
            echo "Response: $body"
            exit 1
          fi

      - name: Deployment Trigger Success Check
        run: |
          echo "CI/CD successful for the develop branch."
          echo "develop branch has been automatically merged into staging."
          echo "Render and Vercel are configured to automatically trigger deployment based on the successful 'build' job."
          echo "Staging environment update should start shortly."

